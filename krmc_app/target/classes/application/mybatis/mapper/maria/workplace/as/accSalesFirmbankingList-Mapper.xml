<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.doppio.workplace.as.service.impl.AccSalesFirmbankingListMapper">

	
	<!-- 매출처펌뱅킹 현황 -->
	<select id="selectaccSalesFirmbankingList" parameterType="com.doppio.workplace.as.service.AccSalesFirmbankingListVo" resultType="com.doppio.workplace.as.service.AccSalesFirmbankingListVo">
		/*AccSalesFirmbankingListMapper.selectaccSalesFirmbankingList*/	
		SELECT TFD.CUST_NAME
			   , TFD.DEAL_DATE
			   , TFD.DEAL_TIME
			   , TFD.VR_ACCT_NO
			   , TFD.TOTAL_AMT
			   , TFD.PROC_FLAG
			   , CASE WHEN TFD.PROC_FLAG = 'N' THEN '미적용'  ELSE '적용' END PROC_FLAG_NM
		  FROM KRMC.TSH_FIRMBANK_DATA AS TFD
		           
	 	 WHERE TFD.DEAL_DATE BETWEEN #{startDt} AND #{endDt}
		 ORDER BY TFD.CUST_NAME, TFD.DEAL_DATE

	</select> 


	<!-- 매출처펌뱅킹 입력 -->
	<insert id="insertAccSalesFirmbankingRegInfo" parameterType="com.doppio.workplace.as.service.AccSalesDepRegVo">
	/*AccSalesFirmbankingListMapper.insertAccSalesFirmbankingRegInfo*/
		INSERT INTO KRMC.TSH_SALES_DEP
	    	(DEP_DT, SALES_CD, SETL_CLASS, SETL_AMT, PROM_DT, PROM_EXP_DT, REMARKS
             , USE_YN, REG_ID, REG_DT, MOD_ID, MOD_DT
			)
		SELECT TFD.DEAL_DATE, TSAI.SALES_CD, '10', TFD.TOTAL_AMT, '', '', 'Firmbanking'
		       , 'Y', 'krmcadmin', NOW(), 'krmcadmin', NOW()
		  FROM KRMC.TSH_FIRMBANK_DATA AS TFD
		       JOIN (SELECT MAX(SALES_CD) AS SALES_CD, VR_ACCT_NO 
                       FROM KRMC.TFM_SALES_ADD_INFO
                      WHERE VR_ACCT_NO = #{vrAcctNo}
                      GROUP BY VR_ACCT_NO
		            ) AS TSAI
		         ON TSAI.VR_ACCT_NO = TFD.VR_ACCT_NO
		 WHERE DEAL_DATE = #{dealDate}
		   AND DEAL_TIME = #{dealTime}
		   AND PROC_FLAG = 'N'
	</insert>
	
	<!-- 매출처펌뱅킹 입력 -->
	<update id="updateAccSalesFirmbankingFlagInfo" parameterType="com.doppio.workplace.as.service.AccSalesDepRegVo">
	/*AccSalesFirmbankingListMapper.updateAccSalesFirmbankingFlagInfo*/
		UPDATE KRMC.TSH_FIRMBANK_DATA
		   SET PROC_FLAG = 'Y'
		 WHERE DEAL_DATE = #{dealDate}
		   AND DEAL_TIME = #{dealTime}
		   AND VR_ACCT_NO = #{vrAcctNo}
		   AND PROC_FLAG = 'N'
	</update>
	
</mapper>
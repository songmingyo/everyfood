<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.doppio.workplace.as.service.impl.AnlBuyPrdtPrftListMapper">

	<!-- 매입처품목별이익현황 조회 -->
	<select id="selectAnlBuyPrdtPrftList" parameterType="com.doppio.workplace.as.service.AnlBuyPrdtPrftListVo" resultType="com.doppio.workplace.as.service.AnlBuyPrdtPrftListVo">
	/*AnlBuyPrdtPrftListMapper.selectAnlBuyPrdtPrftList*/	
        SELECT TBM.BUY_NM
               , TPM.PRDT_CD
               , TPM.PRDT_NM
               , TPM.PRDT_STD
               , IFNULL(CONF_COST.COST,TPM.COST) AS COST
               , IFNULL(A.SALES_QTY,0)*IFNULL(CONF_COST.COST,TPM.COST) AS BUY_AMT
               , A.PRICE
               , A.PURE_AMT
               , A.PURE_AMT - (A.SALES_QTY * IFNULL(CONF_COST.COST,TPM.COST)) AS SALES_PRFT
               , CASE WHEN IFNULL(CONF_COST.COST,TPM.COST) = 0 THEN 0
                         ELSE (IFNULL(A.PRICE,0) - IFNULL(CONF_COST.COST,TPM.COST) ) / IFNULL(CONF_COST.COST,TPM.COST)  * 100 END AS MAR_RATE
               , A.SALES_QTY AS SALES_QTY
          FROM TFM_BUY_MST AS TBM
          
               JOIN TFM_PRDT_MST AS TPM
                   ON TPM.BUY_CD = TBM.BUY_CD
                   
               JOIN 
	               (SELECT A.PRDT_CD,
	                       CASE WHEN SUM(A.SALES_QTY)=0 THEN 0 ELSE ROUND(SUM(A.PURE_AMT) / SUM(A.SALES_QTY),0) END AS PRICE,
	                       SUM(A.SALES_QTY) AS SALES_QTY,
	                       SUM(A.PURE_AMT) AS PURE_AMT
	                  FROM (SELECT PRDT_CD
	                               , SUM(SALES_QTY) AS SALES_QTY
	                               , SUM(PURE_AMT) AS PURE_AMT
	                          FROM TSH_SALES_DLV
	                         WHERE SALES_DT BETWEEN #{searchStartDt} AND #{searchEndDt}
	                         <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
			                   AND PRDT_CD = #{searchPrdtCd}
	                         </if>
	                         GROUP BY PRDT_CD
	                       UNION ALL
	                        SELECT PRDT_CD
	                               , SUM(RTN_QTY)*-1 AS SALES_QTY
	                               , SUM(PURE_AMT)*-1 AS PURE_AMT
	                          FROM TSH_SALES_RETURN
	                         WHERE RTN_DT BETWEEN #{searchStartDt} AND #{searchEndDt}
	                         <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
			                   AND PRDT_CD = #{searchPrdtCd}
	                         </if>
	                         GROUP BY PRDT_CD
	                       ) AS A
	                 GROUP BY A.PRDT_CD
	               ) AS A
	               ON A.PRDT_CD = TPM.PRDT_CD
	           
	           
	           LEFT OUTER JOIN
	               (SELECT A.PRDT_CD
					       , MAX(CASE WHEN DATE_FORMAT(#{searchStartDt}, '%Y%m') = DATE_FORMAT(NOW(), '%Y%m') THEN (CASE WHEN IFNULL(A.COST,0)=0 THEN A.CONF_COST ELSE A.COST END) ELSE A.CONF_COST END) AS COST
					  FROM (
					        SELECT LEFT(TPR.BUY_DT, 6) AS YEAR_MON
					               , TPR.PRDT_CD
					               , IFNULL(MAX(TPR.COST),0) AS COST
					               , 0 AS CONF_COST
					          FROM TBH_PRDT_RCPT AS TPR
					               JOIN
					                   (SELECT PRDT_CD, MAX(BUY_DT) AS MAX_BUY_DT
					                      FROM TBH_PRDT_RCPT
					                     WHERE BUY_DT LIKE CONCAT(DATE_FORMAT(#{searchStartDt}, '%Y%m') , '%')
					                       AND BUY_CONF_YN = 'Y'
					                       AND BUY_QTY != 0
					                     <if test='searchBuyCd != null and searchBuyCd != ""'> 
								           AND BUY_CD = #{searchBuyCd}
						                 </if>
						                 <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
								           AND PRDT_CD = #{searchPrdtCd}
						                 </if>
					                     GROUP BY PRDT_CD
					                   ) AS A
					         WHERE TPR.BUY_DT = A.MAX_BUY_DT
					           AND TPR.PRDT_CD = A.PRDT_CD
					           AND TPR.BUY_CONF_YN = 'Y'
					           AND TPR.BUY_QTY != 0
					         GROUP BY LEFT(TPR.BUY_DT, 6), TPR.PRDT_CD
					     UNION ALL
					        SELECT YEAR_MON
					               , PRDT_CD
					               , 0 AS COST
					               , COST AS CONF_COST
					          FROM TMH_MON_BUY_COST
					         WHERE YEAR_MON = DATE_FORMAT(#{searchStartDt},'%Y%m')
					       ) AS A
					 GROUP BY A.PRDT_CD
          		   ) AS CONF_COST
	                   ON CONF_COST.PRDT_CD = A.PRDT_CD
	                   
              <where>
                <if test='searchBuyCd != null and searchBuyCd != ""'> 
                  AND TBM.BUY_CD = #{searchBuyCd}
	            </if>
                <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
			      AND TPM.PRDT_CD = #{searchPrdtCd}
	            </if>
	            <if test='searchLCd != null and searchLCd != ""'> 
			      AND TPM.L_CD = #{searchLCd}
	            </if>
	            <if test='searchMCd != null and searchMCd != ""'> 
			      AND TPM.M_CD = #{searchMCd}
	            </if>
              </where>
	</select>
	
	<!-- 매입처품목별이익현황 footer -->
	<select id="selectAnlBuyPrdtPrftFooter" parameterType="com.doppio.workplace.as.service.AnlBuyPrdtPrftListVo" resultType="com.doppio.workplace.as.service.AnlBuyPrdtPrftListVo">
	/*AnlBuyPrdtPrftListMapper.selectAnlBuyPrdtPrftFooter*/	
        SELECT CASE WHEN SUM(IFNULL(A.SALES_QTY,0)*IFNULL(CONF_COST.COST,TPM.COST)) = 0 THEN 0
                         ELSE (SUM(A.PURE_AMT) - SUM(IFNULL(A.SALES_QTY,0)*IFNULL(CONF_COST.COST,TPM.COST)) ) / SUM(IFNULL(A.SALES_QTY,0)*IFNULL(CONF_COST.COST,TPM.COST))  * 100 END AS MAR_RATE_SUM
          FROM TFM_BUY_MST AS TBM
               JOIN TFM_PRDT_MST AS TPM
                   ON TPM.BUY_CD = TBM.BUY_CD
               JOIN 
	               (SELECT A.PRDT_CD,
	                       CASE WHEN SUM(A.SALES_QTY)=0 THEN 0 ELSE ROUND(SUM(A.PURE_AMT) / SUM(A.SALES_QTY),0) END AS PRICE,
	                       SUM(A.SALES_QTY) AS SALES_QTY,
	                       SUM(A.PURE_AMT) AS PURE_AMT
	                  FROM (SELECT PRDT_CD
	                               , SUM(SALES_QTY) AS SALES_QTY
	                               , SUM(PURE_AMT) AS PURE_AMT
	                          FROM TSH_SALES_DLV
	                         WHERE SALES_DT BETWEEN #{searchStartDt} AND #{searchEndDt}
	                         <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
			                   AND PRDT_CD = #{searchPrdtCd}
	                         </if>
	                         GROUP BY PRDT_CD
	                       UNION ALL
	                        SELECT PRDT_CD
	                               , SUM(RTN_QTY)*-1 AS SALES_QTY
	                               , SUM(PURE_AMT)*-1 AS PURE_AMT
	                          FROM TSH_SALES_RETURN
	                         WHERE RTN_DT BETWEEN #{searchStartDt} AND #{searchEndDt}
	                         <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
			                   AND PRDT_CD = #{searchPrdtCd}
	                         </if>
	                         GROUP BY PRDT_CD
	                       ) AS A
	                 GROUP BY A.PRDT_CD
	               ) AS A
	               ON A.PRDT_CD = TPM.PRDT_CD
               LEFT OUTER JOIN
	               (SELECT A.PRDT_CD
					       , MAX(CASE WHEN DATE_FORMAT(#{searchStartDt}, '%Y%m') = DATE_FORMAT(NOW(), '%Y%m') THEN (CASE WHEN IFNULL(A.COST,0)=0 THEN A.CONF_COST ELSE A.COST END) ELSE A.CONF_COST END) AS COST
					  FROM (
					        SELECT LEFT(TPR.BUY_DT, 6) AS YEAR_MON
					               , TPR.PRDT_CD
					               , IFNULL(MAX(TPR.COST),0) AS COST
					               , 0 AS CONF_COST
					          FROM TBH_PRDT_RCPT AS TPR
					               JOIN
					                   (SELECT PRDT_CD, MAX(BUY_DT) AS MAX_BUY_DT
					                      FROM TBH_PRDT_RCPT
					                     WHERE BUY_DT LIKE CONCAT(DATE_FORMAT(#{searchStartDt}, '%Y%m') , '%')
					                       AND BUY_CONF_YN = 'Y'
					                       AND BUY_QTY != 0
					                     <if test='searchBuyCd != null and searchBuyCd != ""'> 
								           AND BUY_CD = #{searchBuyCd}
						                 </if>
						                 <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
								           AND PRDT_CD = #{searchPrdtCd}
						                 </if>
					                     GROUP BY PRDT_CD
					                   ) AS A
					         WHERE TPR.BUY_DT = A.MAX_BUY_DT
					           AND TPR.PRDT_CD = A.PRDT_CD
					           AND TPR.BUY_CONF_YN = 'Y'
					           AND TPR.BUY_QTY != 0
					         GROUP BY LEFT(TPR.BUY_DT, 6), TPR.PRDT_CD
					     UNION ALL
					        SELECT YEAR_MON
					               , PRDT_CD
					               , 0 AS COST
					               , COST AS CONF_COST
					          FROM TMH_MON_BUY_COST
					         WHERE YEAR_MON = DATE_FORMAT(#{searchStartDt},'%Y%m')
					       ) AS A
					 GROUP BY A.PRDT_CD
          		   ) AS CONF_COST
	                   ON CONF_COST.PRDT_CD = A.PRDT_CD            
              <where>
                <if test='searchBuyCd != null and searchBuyCd != ""'> 
                  AND TBM.BUY_CD = #{searchBuyCd}
	            </if>
                <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
			      AND TPM.PRDT_CD = #{searchPrdtCd}
	            </if>
	            <if test='searchLCd != null and searchLCd != ""'> 
			      AND TPM.L_CD = #{searchLCd}
	            </if>
	            <if test='searchMCd != null and searchMCd != ""'> 
			      AND TPM.M_CD = #{searchMCd}
	            </if>
              </where>
	</select>


	<!-- 매입처품목별이익현황 엑셀 다운로드 -->
	<select id="selectAnlBuyPrdtPrftListExcelDown" parameterType="com.doppio.workplace.as.service.AnlBuyPrdtPrftListVo" resultType="java.util.HashMap">
	/*AnlBuyPrdtPrftListMapper.selectAnlBuyPrdtPrftListExcelDown*/	
        SELECT TBM.BUY_NM
               , TPM.PRDT_CD
               , TPM.PRDT_NM
               , TPM.PRDT_STD
               , IFNULL(CONF_COST.COST,TPM.COST) AS COST
               , CAST(	IFNULL(A.SALES_QTY,0)*IFNULL(CONF_COST.COST,TPM.COST) AS UNSIGNED) AS BUY_AMT
               , IFNULL(A.PRICE,0) AS PRICE
               , IFNULL(A.PURE_AMT,0) AS PURE_AMT
               , IFNULL(A.PURE_AMT - (A.SALES_QTY * IFNULL(CONF_COST.COST,TPM.COST)),0) AS SALES_PRFT
               , CASE WHEN IFNULL(CONF_COST.COST,TPM.COST) = 0 THEN 0
                         ELSE (IFNULL(A.PRICE,0) - IFNULL(CONF_COST.COST,TPM.COST) ) / IFNULL(CONF_COST.COST,TPM.COST)  * 100 END AS MAR_RATE
               , IFNULL(A.SALES_QTY,0) AS SALES_QTY
          FROM TFM_BUY_MST AS TBM
          
               JOIN TFM_PRDT_MST AS TPM
                   ON TPM.BUY_CD = TBM.BUY_CD
                   
               JOIN 
	               (SELECT A.PRDT_CD,
	                       CASE WHEN SUM(A.SALES_QTY)=0 THEN 0 ELSE ROUND(SUM(A.PURE_AMT) / SUM(A.SALES_QTY),0) END AS PRICE,
	                       SUM(A.SALES_QTY) AS SALES_QTY,
	                       SUM(A.PURE_AMT) AS PURE_AMT
	                  FROM (SELECT PRDT_CD
	                               , SUM(SALES_QTY) AS SALES_QTY
	                               , SUM(PURE_AMT) AS PURE_AMT
	                          FROM TSH_SALES_DLV
	                         WHERE SALES_DT BETWEEN REPLACE(#{searchStartDt},'-','') AND REPLACE(#{searchEndDt},'-','')
	                         <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
			                   AND PRDT_CD = #{searchPrdtCd}
	                         </if>
	                         GROUP BY PRDT_CD
	                       UNION ALL
	                        SELECT PRDT_CD
	                               , SUM(RTN_QTY)*-1 AS SALES_QTY
	                               , SUM(PURE_AMT)*-1 AS PURE_AMT
	                          FROM TSH_SALES_RETURN
	                         WHERE RTN_DT BETWEEN REPLACE(#{searchStartDt},'-','') AND REPLACE(#{searchEndDt},'-','')
	                         <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
			                   AND PRDT_CD = #{searchPrdtCd}
	                         </if>
	                         GROUP BY PRDT_CD
	                       ) AS A
	                 GROUP BY A.PRDT_CD
	               ) AS A
	               ON A.PRDT_CD = TPM.PRDT_CD
	           
	           
	           LEFT OUTER JOIN
	               (SELECT A.PRDT_CD
					       , MAX(CASE WHEN DATE_FORMAT(#{searchStartDt}, '%Y%m') = DATE_FORMAT(NOW(), '%Y%m') THEN (CASE WHEN IFNULL(A.COST,0)=0 THEN A.CONF_COST ELSE A.COST END) ELSE A.CONF_COST END) AS COST
					  FROM (
					        SELECT LEFT(TPR.BUY_DT, 6) AS YEAR_MON
					               , TPR.PRDT_CD
					               , IFNULL(MAX(TPR.COST),0) AS COST
					               , 0 AS CONF_COST
					          FROM TBH_PRDT_RCPT AS TPR
					               JOIN
					                   (SELECT PRDT_CD, MAX(BUY_DT) AS MAX_BUY_DT
					                      FROM TBH_PRDT_RCPT
					                     WHERE BUY_DT LIKE CONCAT(DATE_FORMAT(#{searchStartDt}, '%Y%m') , '%')
					                       AND BUY_CONF_YN = 'Y'
					                       AND BUY_QTY != 0
					                     <if test='searchBuyCd != null and searchBuyCd != ""'> 
								           AND BUY_CD = #{searchBuyCd}
						                 </if>
						                 <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
								           AND PRDT_CD = #{searchPrdtCd}
						                 </if>
					                     GROUP BY PRDT_CD
					                   ) AS A
					         WHERE TPR.BUY_DT = A.MAX_BUY_DT
					           AND TPR.PRDT_CD = A.PRDT_CD
					           AND TPR.BUY_CONF_YN = 'Y'
					           AND TPR.BUY_QTY != 0
					         GROUP BY LEFT(TPR.BUY_DT, 6), TPR.PRDT_CD
					     UNION ALL
					        SELECT YEAR_MON
					               , PRDT_CD
					               , 0 AS COST
					               , COST AS CONF_COST
					          FROM TMH_MON_BUY_COST
					         WHERE YEAR_MON = DATE_FORMAT(#{searchStartDt},'%Y%m')
					       ) AS A
					 GROUP BY A.PRDT_CD
          		   ) AS CONF_COST
	                   ON CONF_COST.PRDT_CD = A.PRDT_CD
	                   
              <where>
                <if test='searchBuyCd != null and searchBuyCd != ""'> 
                  AND TBM.BUY_CD = #{searchBuyCd}
	            </if>
                <if test='searchPrdtCd != null and searchPrdtCd != ""'> 
			      AND TPM.PRDT_CD = #{searchPrdtCd}
	            </if>
	            <if test='searchLCd != null and searchLCd != ""'> 
			      AND TPM.L_CD = #{searchLCd}
	            </if>
	            <if test='searchMCd != null and searchMCd != ""'> 
			      AND TPM.M_CD = #{searchMCd}
	            </if>
              </where>
	</select>

</mapper>
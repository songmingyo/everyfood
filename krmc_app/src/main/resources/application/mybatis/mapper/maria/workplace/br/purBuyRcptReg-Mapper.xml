<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.doppio.workplace.br.service.impl.BuyRcptRegMapper">

	
	<!-- 매입 내역 조회 -->
	<select id="selectBuyRcptList" parameterType="com.doppio.workplace.br.service.BuyRcptRegVo" resultType="com.doppio.workplace.br.service.BuyRcptRegVo">
	/*BuyRcptRegMapper.selectBuyRcptList*/
		SELECT TPR.BUY_SLIP_NO
		       , TPR.BUY_CD
			   , TBM.BUY_NM
			   , TPR.ORD_DT
			   , TPR.BUY_DT
               , SUM(IFNULL(TPR.PURE_AMT,0)) AS PURE_AMT
			   , SUM(IFNULL(TPR.VAT_AMT,0)) AS VAT_AMT
			   , SUM(IFNULL(TPR.TOT_AMT,0)) AS TOT_AMT

               , MAX(TCD.DTL_NM) AS BUY_CONF_YN
               , CASE WHEN MAX(IFNULL(TPR.TERM_VAL,''))='' THEN '미입력' ELSE '입력' END AS TERM_VAL_YN

               , MAX(TM.USER_NM) AS REG_NM
               , MAX(TPR.REG_DT) AS REG_DT
   		                      
		  FROM KRMC.TBH_PRDT_RCPT AS TPR
		       LEFT OUTER JOIN KRMC.TFM_BUY_MST AS TBM
			       ON TBM.BUY_CD = TPR.BUY_CD
		           
		       LEFT OUTER JOIN KRMC.TCM_MEMBER AS TM
		           ON TM.USER_ID = TPR.REG_ID
		           
		       LEFT OUTER JOIN KRMC.TCM_CODE_DTL AS TCD
		           ON TCD.DTL_CD = TPR.BUY_CONF_YN
		           AND TCD.COM_CD = 'M009'
		
		 WHERE TPR.BUY_DT BETWEEN REPLACE(#{buyStartDt},'-','') AND REPLACE(#{buyEndDt},'-','')
		   AND TPR.BUY_QTY != 0
		 <if test='buyCd != null and buyCd != ""'>		<!-- 매입처코드  --> 
			AND TPR.BUY_CD = #{buyCd}
	 	 </if>
		 <if test='buyConfYn != null and buyConfYn != ""'>		<!-- 매입처코드  --> 
			AND TPR.BUY_CONF_YN = #{buyConfYn}
		 </if>
		
		 GROUP BY TPR.BUY_SLIP_NO, TPR.BUY_CD, TBM.BUY_NM, TPR.ORD_DT, TPR.BUY_DT
		 ORDER BY TPR.BUY_CD, TPR.ORD_DT
	</select>
	
	<!-- 매입 내역 상세 조회 -->
	<select id="selectBuyRcptDetailList" parameterType="com.doppio.workplace.br.service.BuyRcptRegVo" resultType="com.doppio.workplace.br.service.BuyRcptRegVo">
	/*BuyRcptRegMapper.selectBuyRcptDetailList*/	
		SELECT IFNULL(TPR.BUY_SLIP_NO,'') AS BUY_SLIP_NO
			   , IFNULL(TPR.BUY_SEQ, 0) AS BUY_SEQ
		       , TPR.BUY_CD
			   , TBM.BUY_NM
			   , TPR.PRDT_CD
			   , CONCAT(TPM.PRDT_NM, TPM.PRDT_STD) AS PRDT_NM
			   , TCD_1.DTL_NM AS ORD_UNIT
			   , TPR.BUY_DT
			   , TPR.ORD_QTY
			   , TPR.BUY_QTY
			   , TPR.BOX_QTY
			   , TPR.COST			   
			   , IFNULL(TPR.PURE_AMT,0) AS PURE_AMT
			   , IFNULL(TPR.VAT_AMT,0) AS VAT_AMT
			   , IFNULL(TPR.TOT_AMT,0) AS TOT_AMT
			   , TPM.EXPRT_DT
			   , TPR.TERM_VAL
			   , TPR.BUY_CONF_YN
			   , TWM.WH_NM
			   , TPR.REMARKS
			   , TM.USER_NM AS MOD_NM
               , TPR.MOD_DT
				
			   , TPR.ORD_DT
			   , TPM.VAT_YN
			   , TPM.QTY_BOX
			   
			   , TPR.BUY_QTY AS BUY_QTY_ORG
			   , IFNULL(TPR.PURE_AMT,0) AS PURE_AMT_ORG
			   , IFNULL(TPR.VAT_AMT,0) AS VAT_AMT_ORG
			   
			   , CASE WHEN TPR.BUY_SLIP_NO IS NULL THEN 'I' ELSE 'U' END AS GRID_FLAG
   		                      
		  FROM KRMC.TBH_PRDT_RCPT AS TPR
		       LEFT OUTER JOIN KRMC.TFM_BUY_MST AS TBM
			       ON TBM.BUY_CD = TPR.BUY_CD
			   
			   LEFT OUTER JOIN KRMC.TFM_PRDT_MST AS TPM
		           ON TPM.PRDT_CD = TPR.PRDT_CD
		           
		       LEFT OUTER JOIN KRMC.TCM_CODE_DTL AS TCD_1
		           ON TCD_1.DTL_CD = TPM.ORD_UNIT
		           AND TCD_1.COM_CD = 'M006'
		           
		       LEFT OUTER JOIN KRMC.TCM_MEMBER AS TM
		           ON TM.USER_ID = TPR.MOD_ID
		           
		       LEFT OUTER JOIN KRMC.TFM_WH_MST AS TWM
		           ON TWM.WH_CD = TPR.WH_CD

		 WHERE TPR.BUY_SLIP_NO = #{buySlipNo}
		   AND TPR.BUY_DT = #{buyDt}
		   AND TPR.ORD_DT = #{ordDt}
		   AND TPR.BUY_CD = #{buyCd}
		   AND TPR.BUY_QTY != 0
		 ORDER BY TPR.PRDT_CD
	</select>
	
	
	<!-- 매입 추가 품목 조회 -->
	<select id="selectBuyRcptRegPrdtAddList" parameterType="com.doppio.workplace.br.service.BuyRcptRegVo" resultType="com.doppio.workplace.br.service.BuyRcptRegVo">
	/*BuyRcptRegMapper.selectBuyRcptRegPrdtAddList*/	
		SELECT TPM.BUY_CD
			   , TBM.BUY_NM
			   , TPM.PRDT_CD
			   , CONCAT(TPM.PRDT_NM, TPM.PRDT_STD) AS PRDT_NM
			   , TCD.DTL_NM AS ORD_UNIT
			   , TPM.COST			   
			   , TPM.EXPRT_DT
			   , 'Y' AS BUY_CONF_YN
			   , TWM.WH_NM
			   , '' AS REMARKS
               , TPM.VAT_YN
			   , TPM.QTY_BOX
			   , TPM.STD_YN
			   
			   , 0 AS ORD_QTY
			   , 0 AS BUY_QTY
			   
   		       
			   , '' AS ORD_DT
			   , '' AS BUY_DT
			   
			   , 'I' AS GRID_FLAG
			                  
		  FROM KRMC.TFM_PRDT_MST AS TPM
		       LEFT OUTER JOIN KRMC.TFM_BUY_MST AS TBM
			       ON TBM.BUY_CD = TPM.BUY_CD
			   
		       LEFT OUTER JOIN KRMC.TCM_CODE_DTL AS TCD
		           ON TCD.DTL_CD = TPM.ORD_UNIT
		           AND TCD.COM_CD = 'M006'
		           
		       LEFT OUTER JOIN KRMC.TFM_WH_MST AS TWM
		           ON TWM.WH_CD = #{whCd}

		 WHERE TPM.PRDT_CD = #{prdtCd}
		   AND TPM.BUY_CD = #{buyCd}
	</select>
	
	<!-- 매입처 발주 신규 전표번호 저장 -->
	<insert id="insertBuyRcptSlipNo" parameterType="String">
	/*BuyOrderRegMapper.insertBuyRcptSlipNo*/
	<selectKey keyProperty="buySlipNo" resultType="String" order="BEFORE">
		SELECT CASE WHEN A.BUY_SLIP_NO IS NOT NULL
	           THEN A.BUY_SLIP_NO
	           ELSE (SELECT CONCAT(#{buyDt}, '-', LPAD(CAST(RIGHT(IFNULL(MAX(BUY_SLIP_NO),'0000'),4) AS DECIMAL)+1, 4, 0)) AS BUY_SLIP_NO
			           FROM TBH_DAY_SLIPNO
			          WHERE BUY_SLIP_DT = #{buyDt}	                  
	                )
	           END BUY_SLIP_NO
	      FROM (SELECT MAX(BUY_SLIP_NO) AS BUY_SLIP_NO
	              FROM KRMC.TBH_PRDT_RCPT
	             WHERE BUY_DT = #{buyDt}
	           ) AS A
	</selectKey>
	    INSERT IGNORE INTO KRMC.TBH_DAY_SLIPNO
            (BUY_SLIP_DT, BUY_SLIP_NO
             , REG_DT)
        VALUES
            (SUBSTRING(#{buySlipNo},1,8), #{buySlipNo}
			 , NOW()
            )
	</insert>
	
	<!-- 매입처 입고 신규 저장 -->
	<insert id="insertBuyRcptRegData" parameterType="com.doppio.workplace.br.service.BuyRcptRegVo">
	/*BuyRcptRegMapper.insertBuyRcptRegData*/
	<selectKey keyProperty="buySeq" resultType="String" order="BEFORE">
		SELECT IFNULL(MAX(BUY_SEQ),0)+1 AS BUY_SEQ
          FROM TBH_PRDT_RCPT
         WHERE BUY_SLIP_NO = #{buySlipNo}
	</selectKey>
	    INSERT INTO KRMC.TBH_PRDT_RCPT
            (BUY_SLIP_NO, BUY_SEQ, BUY_DT, BUY_CD, PRDT_CD, WH_CD, ORD_DT
             , COST, BOX_QTY, ORD_QTY, BUY_QTY, PURE_AMT, VAT_AMT, TOT_AMT, TERM_VAL, BUY_CONF_YN, REMARKS
             , USE_YN, REG_ID, REG_DT, MOD_ID, MOD_DT
            )
        VALUES
        	(#{buySlipNo}, #{buySeq}, #{buyDt}, #{buyCd}, #{prdtCd}, #{whCd}, #{buyDt}
             , #{cost}, #{boxQty}, #{ordQty}, #{buyQty}, #{pureAmt}, #{vatAmt}, #{totAmt}, #{termVal}, #{buyConfYn}, #{remarks}
			 , 'Y', #{workId}, NOW(), #{workId}, NOW()
            )
	</insert>

	<!-- 매입처 입고 수정 -->
	<update id="updateBuyRcptRegData" parameterType="com.doppio.workplace.br.service.BuyRcptRegVo">
	/*BuyRcptRegMapper.updateBuyRcptRegData*/
        UPDATE KRMC.TBH_PRDT_RCPT
           SET BUY_DT			= #{buyDt}
               , BOX_QTY		= #{boxQty}
           	   , BUY_QTY   		= #{buyQty}
               , PURE_AMT   	= #{pureAmt}
               , VAT_AMT    	= #{vatAmt}
               , TOT_AMT    	= #{totAmt}
               , TERM_VAL   	= #{termVal}
               , BUY_CONF_YN  	= #{buyConfYn}
               , REMARKS    	= #{remarks}
               , MOD_ID     	= #{workId}
               , MOD_DT     	= NOW()
         WHERE BUY_SLIP_NO = #{buySlipNo}
           AND BUY_SEQ     = #{buySeq}
	</update>

	
</mapper>

